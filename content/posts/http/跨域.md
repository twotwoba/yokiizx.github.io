---
title: '同源策略和CORS'
date: 2022-09-22T19:13:03+08:00
tags: [http]
---

## 前言

同源策略(same origin policy)是由网景公司提出的最基础的安全策略。

同源，就是协议，域名和端口。当其中一个不同，就会产生跨域问题。

## CORS

`CORS` 是 W3C 标准，的全名是 `Cross-Origin Resource Sharing`，即跨域资源共享机制，满足可以跨域请求资源。

浏览器会自动向 HTTP header 添加一个额外的请求头字段：Origin。Origin 标记了请求的站点来源：

```http
GET https://api.target.com/demo HTTP/1.1
Origin: https://www.source.com // <- 浏览器自己加的
```

为了使浏览器允许访问跨域资源，服务器返回的 response 还需要加一些响应头字段，这些字段将显式表明此服务器是否允许这个跨域请求。

- Access-Control-Allow-Origin 必须的，指定可访问的源
- Access-Control-Allow-Methods
- Access-Control-Allow-Headers
- Access-Control-Allow-Credentials 带上 cookie，ajax/axios 也要配置 `withCredential`
- Access-Control-Expose-Headers 暴露更多可获取的响应头
- Access-Control-Max-Age 指定预检请求有效期

##### 处理机制

CORS 把请求分为了两种，简单请求和非简单请求，其中非简单请求需要先发起一次 OPTIONS 预检请求。

简单请求：

1. GET/HEAD/POST 三者之一
2. 请求头不超出以下几个字段
   - Accept
   - Accept-Language
   - Last-Event-ID
   - Content-Language
   - Content-Type：application/x-www-form-urlencoded、multipart/form-data、text/plain 三者之一

发起简单请求时，自动带上 origin，服务器返回数据，并返回检查结果，配置 CORS 响应头，浏览器对响应头进行检查，包含则放行，否则拦截。

非简单请求：

先发起一次 options 预检请求，过程与简单请求一致，响应头没有通过检查就不会发起真正的请求。

只对非简单请求做预检是因为，此类请求往往会对服务器产生副作用。

##### 为什么请求要带上 origin

主要是因为 CORS 给开发带来了便利，同时也带来了安全隐患——CSRF 攻击。
![](https://cdn.staticaly.com/gh/yokiizx/picgo@master/img/202210280002617.png)
如果严格按照同源政策，第 2 步的跨域请求不能进行的，也就不会造成危害。所以 CORS 策略的心智模型是：所有跨域请求都是不安全的，浏览器要带上来源给服务器检验。

##### html 标签的跨域

TODO 其他常用的解决跨域方式

## 参考

- [跨域资源共享 CORS 详解](https://www.ruanyifeng.com/blog/2016/04/cors.html)
- [http 演进之路四](https://zhuanlan.zhihu.com/p/50979016)
- [CORS 为什么能保障安全？为什么只对复杂请求做预检？](https://mp.weixin.qq.com/s/W38vyzlqRtUysjguHeqiNQ)
- [9 种常见的前端跨域解决方案](https://juejin.cn/post/6844903882083024910)
